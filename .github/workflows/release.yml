name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-and-release:
    name: Build ffan for macOS
    runs-on: macos-latest  # GitHub provides free macOS runners!
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Building version: $VERSION"
      
      - name: âš™ï¸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: ğŸ”¨ Build ffan
        run: |
          echo "ğŸ—ï¸ Building ffan..."
          xcodebuild \
            -project fan.xcodeproj \
            -scheme fan \
            -configuration Release \
            -derivedDataPath build \
            clean build
          
          # The app is built to a predictable location
          BUILT_APP="build/Build/Products/Release/fan.app"
          
          if [ ! -d "$BUILT_APP" ]; then
            echo "âŒ Error: Built app not found at $BUILT_APP"
            echo "Looking for app in build directory:"
            find build -name "*.app" -type d
            exit 1
          fi
          
          echo "âœ… Built app: $BUILT_APP"
          
          # Create release directory
          mkdir -p release
          cp -R "$BUILT_APP" release/ffan.app
      
      - name: ï¿½ Sign Application
        run: |
          echo "ğŸ” Ad-hoc signing app for macOS Apple Silicon support..."
          # Ensure executable permission
          chmod +x release/ffan.app/Contents/MacOS/*
          # Ad-hoc sign to allow running on ARM64
          codesign --force --deep --options runtime --sign - release/ffan.app
      
      - name: ğŸ“¦ Create ZIP archive
        run: |
          cd release
          zip -r ../ffan-v${{ steps.version.outputs.version }}-macos.zip ffan.app -x "*.DS_Store"
          cd ..
          
          # Calculate checksum
          shasum -a 256 ffan-v${{ steps.version.outputs.version }}-macos.zip > ffan-v${{ steps.version.outputs.version }}-macos.zip.sha256
          
          echo "ğŸ“¦ Archive created:"
          ls -lh ffan-v${{ steps.version.outputs.version }}-macos.zip
      
      - name: ğŸ’¿ Create DMG with Shortcut
        run: |
          echo "ğŸ’¿ Creating DMG with Applications shortcut..."
          # Create staging directory for DMG content
          mkdir -p dmg_source
          cp -R release/ffan.app dmg_source/
          
          # Create symlink to Applications
          ln -s /Applications dmg_source/Applications
          
          # Create DMG from staging directory
          hdiutil create -volname "ffan" \
            -srcfolder dmg_source \
            -ov -format UDZO \
            ffan-v${{ steps.version.outputs.version }}-macos.dmg
          
          shasum -a 256 ffan-v${{ steps.version.outputs.version }}-macos.dmg > ffan-v${{ steps.version.outputs.version }}-macos.dmg.sha256
      
      - name: ğŸ“ Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸŒ¬ï¸ ffan v${{ steps.version.outputs.version }}
          
          ### âœ¨ Features
          - ğŸŒ¡ï¸ Real-time CPU/GPU temperature monitoring
          - ğŸ’¨ Manual and automatic fan speed control
          - ğŸ“Š Animated menu bar icon
          - ğŸš€ Launch at login support
          - ğŸ¨ Modern liquid glass UI
          
          ### ğŸ“¦ Installation
          ```bash
          # Quick install
          curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ffan-v${{ steps.version.outputs.version }}-macos.zip -o ffan.zip
          unzip ffan.zip
          mv ffan.app /Applications/
          
          # Enable fan control
          cd /Applications/ffan.app/Contents/Resources/tools/smc-helper
          sudo ./install.sh
          ```
          
          ### ğŸ“‹ Requirements
          - macOS 11.0+
          - Intel or Apple Silicon
          
          ### ğŸ” SHA256 Checksums
          ```
          $(cat ffan-v${{ steps.version.outputs.version }}-macos.zip.sha256)
          $(cat ffan-v${{ steps.version.outputs.version }}-macos.dmg.sha256)
          ```
          
          ### ğŸ“š [Full Documentation](https://github.com/${{ github.repository }}/blob/main/docs/README.md)
          
          ---
          **â­ Like ffan? Star the repo!**
          EOF
          
          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
      
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: ffan v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ffan-v${{ steps.version.outputs.version }}-macos.zip
            ffan-v${{ steps.version.outputs.version }}-macos.zip.sha256
            ffan-v${{ steps.version.outputs.version }}-macos.dmg
            ffan-v${{ steps.version.outputs.version }}-macos.dmg.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ Upload artifacts (for non-tag builds)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: ffan-dev-build
          path: |
            ffan-v${{ steps.version.outputs.version }}-macos.zip
            ffan-v${{ steps.version.outputs.version }}-macos.dmg
          retention-days: 30
      
      - name: âœ… Done!
        run: |
          echo "âœ¨ Build complete!"
          echo "ğŸ“ Version: ${{ steps.version.outputs.version }}"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "ğŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
          else
            echo "ğŸ’¾ Artifacts uploaded for manual testing"
          fi
