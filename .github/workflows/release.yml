name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-and-release:
    name: Build ffan for macOS
    runs-on: macos-latest  # GitHub provides free macOS runners!
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Building version: $VERSION"
      
      - name: âš™ï¸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: ğŸ”¨ Build ffan
        run: |
          echo "ğŸ—ï¸ Building ffan..."
          xcodebuild \
            -project fan.xcodeproj \
            -scheme fan \
            -configuration Release \
            -derivedDataPath build \
            clean build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM=""
          
          # The app is built to a predictable location
          BUILT_APP="build/Build/Products/Release/fan.app"
          
          if [ ! -d "$BUILT_APP" ]; then
            echo "âŒ Error: Built app not found at $BUILT_APP"
            echo "Looking for app in build directory:"
            find build -name "*.app" -type d
            exit 1
          fi
          
          echo "âœ… Built app: $BUILT_APP"
          
          # Create release directory
          mkdir -p release
          cp -R "$BUILT_APP" release/ffan.app
      
      - name: ï¿½ Sign Application
        run: |
          echo "ğŸ” Ad-hoc signing app for macOS Apple Silicon support..."
          # Ensure executable permission
          chmod +x release/ffan.app/Contents/MacOS/*
          # Ad-hoc sign to allow running on ARM64
          codesign --force --deep --options runtime --sign - release/ffan.app
      
      - name: ğŸ“¦ Create ZIP archive
        run: |
          cd release
          zip -r ../ffan-v${{ steps.version.outputs.version }}-macos.zip ffan.app -x "*.DS_Store"
          cd ..
          
          # Calculate checksum
          shasum -a 256 ffan-v${{ steps.version.outputs.version }}-macos.zip > ffan-v${{ steps.version.outputs.version }}-macos.zip.sha256
          
          echo "ğŸ“¦ Archive created:"
          ls -lh ffan-v${{ steps.version.outputs.version }}-macos.zip
      
      - name: ğŸ’¿ Create Styled DMG
        run: |
          echo "ğŸ’¿ Creating styled DMG with custom background..."
          
          # DMG dimensions (4:3 aspect ratio)
          DMG_WIDTH=640
          DMG_HEIGHT=480
          
          # Create staging directory
          mkdir -p dmg_source/.background
          cp -R release/ffan.app dmg_source/
          ln -s /Applications dmg_source/Applications
          
          # Resize background image to exactly fit DMG window
          sips -z $DMG_HEIGHT $DMG_WIDTH assets/installer_bg.png --out dmg_source/.background/background.png
          
          # Create temporary DMG (read-write)
          hdiutil create -volname "ffan" \
            -srcfolder dmg_source \
            -ov -format UDRW \
            -size 200m \
            temp_ffan.dmg
          
          # Mount the DMG
          MOUNT_DIR=$(hdiutil attach -readwrite -noverify temp_ffan.dmg | grep "Volumes" | awk '{print $3}')
          echo "Mounted at: $MOUNT_DIR"
          
          # Use AppleScript to set DMG window appearance
          osascript <<EOF
          tell application "Finder"
            tell disk "ffan"
              open
              set current view of container window to icon view
              set toolbar visible of container window to false
              set statusbar visible of container window to false
              set bounds of container window to {100, 100, $((100 + DMG_WIDTH)), $((100 + DMG_HEIGHT))}
              set viewOptions to the icon view options of container window
              set arrangement of viewOptions to not arranged
              set icon size of viewOptions to 128
              set background picture of viewOptions to file ".background:background.png"
              set position of item "ffan.app" of container window to {160, 280}
              set position of item "Applications" of container window to {480, 280}
              close
              open
              update without registering applications
              delay 2
            end tell
          end tell
          EOF
          
          # Sync and unmount
          sync
          hdiutil detach "$MOUNT_DIR"
          
          # Convert to compressed read-only DMG
          hdiutil convert temp_ffan.dmg \
            -format UDZO \
            -imagekey zlib-level=9 \
            -o ffan-v${{ steps.version.outputs.version }}-macos.dmg
          
          rm temp_ffan.dmg
          
          shasum -a 256 ffan-v${{ steps.version.outputs.version }}-macos.dmg > ffan-v${{ steps.version.outputs.version }}-macos.dmg.sha256
      
      - name: ğŸ“ Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸŒ¬ï¸ ffan v${{ steps.version.outputs.version }}
          
          ### âœ¨ Features
          - ğŸŒ¡ï¸ Real-time CPU/GPU temperature monitoring
          - ğŸ’¨ Manual and automatic fan speed control
          - ğŸ“Š Animated menu bar icon
          - ğŸš€ Launch at login support
          - ğŸ¨ Modern liquid glass UI
          
          ### ğŸ“¦ Installation
          
          **Option 1: GUI Installation (Recommended)**
          1. Download and open the DMG
          2. Drag ffan.app to /Applications/
          3. Launch the app - it will prompt you to install the helper tool
          4. Click "Install Helper" and enter your password once
          5. Done! No more password prompts needed.
          
          **Option 2: Command Line Installation**
          
          Quick install (auto-detects latest version):
          ```bash
          curl -fsSL https://raw.githubusercontent.com/mohamadlounnas/ffan/main/scripts/install.sh | bash
          ```
          
          Or manual installation:
          ```bash
          curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ffan-v${{ steps.version.outputs.version }}-macos.zip -o ffan.zip
          unzip ffan.zip
          rm -rf /Applications/ffan.app
          mv ffan.app /Applications/
          sudo cp /Applications/ffan.app/Contents/Resources/smc-helper /usr/local/bin/
          sudo chown root:wheel /usr/local/bin/smc-helper
          sudo chmod 4755 /usr/local/bin/smc-helper
          ```
          
          ### ğŸ“‹ Requirements
          - macOS 11.0+
          - Intel or Apple Silicon
          
          ### ğŸ” SHA256 Checksums
          ```
          $(cat ffan-v${{ steps.version.outputs.version }}-macos.zip.sha256)
          $(cat ffan-v${{ steps.version.outputs.version }}-macos.dmg.sha256)
          ```
          
          ### ğŸ“š [Full Documentation](https://github.com/${{ github.repository }}/blob/main/docs/README.md)
          
          ---
          **â­ Like ffan? Star the repo!**
          EOF
          
          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
      
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: ffan v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ffan-v${{ steps.version.outputs.version }}-macos.zip
            ffan-v${{ steps.version.outputs.version }}-macos.zip.sha256
            ffan-v${{ steps.version.outputs.version }}-macos.dmg
            ffan-v${{ steps.version.outputs.version }}-macos.dmg.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¤ Upload artifacts (for non-tag builds)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: ffan-dev-build
          path: |
            ffan-v${{ steps.version.outputs.version }}-macos.zip
            ffan-v${{ steps.version.outputs.version }}-macos.dmg
          retention-days: 30
      
      - name: âœ… Done!
        run: |
          echo "âœ¨ Build complete!"
          echo "ğŸ“ Version: ${{ steps.version.outputs.version }}"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "ğŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
          else
            echo "ğŸ’¾ Artifacts uploaded for manual testing"
          fi
